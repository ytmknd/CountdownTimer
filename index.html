<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>カウントダウンタイマー</title>
  <style>
    :root {
      --green:#28c76f;
      --green-dark:#22b364;
      --bg:#f6f7fb;
      --card:#ffffff;
      --text:#222;
      --muted:#666;
      --ring:#cfeeda;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Hiragino Kaku Gothic ProN", Meiryo, sans-serif;
      background:var(--bg); color:var(--text);
    }
    header{
      display:flex; align-items:center; gap:.6rem; padding:14px 18px; border-bottom:1px solid #e7e7e7; background:#fff;
      position:sticky; top:0; z-index:2;
    }
    header h1{ font-size:18px; margin:0; }

    .wrap{ max-width:980px; margin:24px auto; padding:0 16px; }

    .grid{ display:grid; grid-template-columns: repeat(auto-fit, minmax(240px,1fr)); gap:16px; }

    .card{ background:var(--card); border-radius:18px; padding:18px; box-shadow:0 10px 30px rgba(0,0,0,.06); display:flex; align-items:center; justify-content:center; min-height:160px; position:relative; }

    /* Buttons */
    .primary-btn{ appearance:none; border:none; background:var(--green); color:#fff; font-weight:700; border-radius:999px; padding:14px 22px; cursor:pointer; font-size:16px; box-shadow:0 6px 16px rgba(40,199,111,.35); transition: transform .04s ease, box-shadow .2s ease, background .2s ease; }
    .primary-btn:hover{ background:var(--green-dark); }
    .primary-btn:active{ transform: translateY(1px); }

    /* Modal */
    .modal-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; align-items:center; justify-content:center; z-index:10; }
    .modal{ width:min(92vw,480px); background:#fff; border-radius:18px; box-shadow:0 20px 80px rgba(0,0,0,.35); overflow:hidden; }
    .modal .head{ background:var(--green); color:#fff; padding:12px 18px; display:flex; align-items:center; justify-content:center; gap:18px; }
    .modal .head h2{ margin:0; font-size:22px; letter-spacing:.05em; }

    .picker{ display:grid; grid-template-columns: 1fr 1fr; padding:14px 18px 6px; gap:16px; }
    .picker .col{ background:#f4f9f6; border:1px solid #e8f4eb; border-radius:14px; padding:12px; }
    .picker label{ display:block; font-size:13px; color:#0a8a46; margin-bottom:6px; letter-spacing:.08em; }
    select{ width:100%; height:260px; border:none; outline:none; background:transparent; font-weight:700; font-size:22px; color:#0d5132; padding:4px; scroll-snap-type:y mandatory; }
    select option{ font-size:22px; padding:8px; scroll-snap-align:start; }
    select:disabled{ opacity:.55; cursor:not-allowed; filter:grayscale(0.2); }

    .modal .big-display{ text-align:center; font-variant-numeric: tabular-nums; font-weight:800; font-size:72px; letter-spacing:.05em; color:#fff; background:var(--green); }
    .modal .big-display span{ display:inline-block; padding:10px 0 16px; }

    .modal .foot{ display:flex; justify-content:space-between; align-items:center; padding:14px 18px 18px; }
    .ghost{ background:transparent; border:none; color:#888; font-weight:600; padding:8px 14px; cursor:pointer; }
    .ghost:hover{ color:#333; }

    /* Timer Overlay */
    .overlay{ position:fixed; inset:0; background:rgba(0,0,0,.48); display:none; align-items:center; justify-content:center; z-index:20; }
    .timer{ width:min(92vw,560px); background:#111; color:#fff; border-radius:22px; overflow:hidden; display:flex; flex-direction:column; align-items:center; }

    .ring{ position:relative; width:86%; aspect-ratio:1/1; margin:28px auto 8px; display:grid; place-items:center; }
    .ring svg{ position:absolute; inset:0; transform:rotate(-90deg); }
    .ring .time{ position:relative; z-index:1; font-size:72px; font-weight:800; letter-spacing:.06em; font-variant-numeric:tabular-nums; }

    .controls{ display:flex; align-items:center; justify-content:center; gap:14px; margin:16px 0 26px; }
    .play{ width:74px; height:74px; border-radius:50%; border:none; background:var(--green); color:#fff; cursor:pointer; display:grid; place-items:center; font-size:0; box-shadow:0 8px 24px rgba(40,199,111,.45); }
    .play svg{ width:32px; height:32px; }
    .icon-btn{ width:42px; height:42px; border-radius:50%; background:#222; color:#fff; border:none; display:grid; place-items:center; cursor:pointer; }

    .meta{ width:100%; display:flex; justify-content:space-between; align-items:center; padding:12px 16px; border-top:1px solid #222; }
    .meta .left{ color:#bbb; display:flex; align-items:center; gap:16px; }
    .meta .link{ color:#f3f3f3; text-decoration:underline; cursor:pointer; }

    .badge{ position:absolute; top:10px; left:50%; transform:translateX(-50%); background:#333; color:#e9f9ef; padding:3px 10px; border-radius:10px; font-size:12px; font-weight:700; }

    .visually-hidden{ position:absolute !important; height:1px; width:1px; overflow:hidden; clip:rect(1px,1px,1px,1px); white-space:nowrap; }
  </style>
</head>
<body>
  <header>
    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#28c76f" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
    <h1>カウントダウンタイマー</h1>
  </header>

  <main class="wrap">
    <div class="grid"><!-- ロード直後は何も表示しない（モーダルのみ） --></div>
  </main>

  <!-- Create Modal -->
  <div class="modal-backdrop" id="createModal" style="display:flex">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="dlgTitle">
      <div class="head"><h2 id="dlgTitle">時間を設定</h2></div>
      <div class="big-display"><span id="preview">05:00</span></div>
      <div class="picker">
        <div class="col">
          <label for="minSel">分</label>
          <select id="minSel" size="12" aria-label="分"><!-- options injected --></select>
        </div>
        <div class="col">
          <label for="secSel">秒</label>
          <select id="secSel" size="12" aria-label="秒"></select>
        </div>
      </div>
      <div class="foot" style="justify-content:flex-end; gap:12px;">
        <button class="primary-btn" id="confirmCreate">作成する</button>
      </div>
    </div>
  </div>

  <!-- Timer Overlay -->
  <div class="overlay" id="timerOverlay" aria-live="polite">
    <div class="timer" role="dialog" aria-modal="true" aria-labelledby="timerTitle">
      <div class="badge" id="badge">00:00</div>
      <div class="ring">
        <svg viewBox="0 0 100 100" preserveAspectRatio="xMidYMid meet">
          <circle cx="50" cy="50" r="46" stroke="var(--ring)" stroke-width="6" fill="none"/>
          <circle id="progress" cx="50" cy="50" r="46" stroke="var(--green)" stroke-width="6" fill="none" stroke-linecap="round" stroke-dasharray="289" stroke-dashoffset="0"/>
        </svg>
        <div class="time" id="bigTime" aria-live="polite">05:00</div>
      </div>
      <div class="controls">
        <button class="icon-btn" id="muteBtn" aria-label="サウンドオン/オフ">
          <svg id="soundOnIcon" viewBox="0 0 24 24" width="22" height="22" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
            <path d="M19 5a7 7 0 0 1 0 14"></path>
          </svg>
          <svg id="soundOffIcon" viewBox="0 0 24 24" width="22" height="22" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" style="display:none">
            <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
            <line x1="23" y1="9" x2="17" y2="15"></line>
            <line x1="17" y1="9" x2="23" y2="15"></line>
          </svg>
        </button>
        <button class="play" id="playPause" aria-label="開始">
          <svg id="playIcon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><polygon points="5 3 19 12 5 21 5 3"/></svg>
          <svg id="pauseIcon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" style="display:none"><rect x="6" y="4" width="4" height="16"></rect><rect x="14" y="4" width="4" height="16"></rect></svg>
        </button>
        <button class="icon-btn" id="resetBtn" aria-label="リセット">
          <svg viewBox="0 0 24 24" width="22" height="22" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/>
          </svg>
        </button>
      </div>
      <div class="meta">
        <div class="left"><span id="status">停止中</span></div>
        <div><span class="link" id="deleteTimer">削除</span></div>
      </div>
    </div>
  </div>

  <audio id="beep" class="visually-hidden" preload="auto">
    <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmQaBTGN2fPPfCwGK4DO8tiNOQkZaLvt559NEAxQp+PwtmMcBjiR1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmQaBTGN2fPPfCwGK4DO8tiNOQkZaLvt559NEAxQp+PwtmMcBjiR1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmQaBTGN2fPPfCwGK4DO8tiNOQkZaLvt559NEAxQp+PwtmMcBjiR1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmQaBTGN2fPPfCwGK4DO8tiNOQkZaLvt559NEAxQp+PwtmMcBjiR1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmQaBTGN2fPPfCwGK4DO8tiNOQkZaLvt559NEAxQp+PwtmMcBjiR1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmQaBTGN2fPPfCwGK4DO8tiNOQkZaLvt559NEAxQp+PwtmMcBjiR1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmQaBTGN2fPPfCwGK4DO8tiNOQkZaLvt559NEAxQp+PwtmMcBjiR1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmQaBTGN2fPPfCwGK4DO8tiNOQkZaLvt559NEAxQp+PwtmMcBjiR1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmQaBTGN2fPPfCwGK4DO8tiNOQkZaLvt559NEAxQp+PwtmMcBjiR1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmQaBTGN2fPPfCwGK4DO8tiNOQkZaLvt559NEAxQp+PwtmMcBjiR1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmQaBTGN2fPPfCwGK4DO8tiNOQkZaLvt559NEAxQp+PwtmMcBjiR1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmQaBTGN2fPPfCwGK4DO8tiNOQkZaLvt559NEAxQp+PwtmMcBjiR1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmQaBTGN2fPPfCwGK4DO8tiNOQ=" type="audio/wav">
  </audio>

  <script>
  // ------- Utilities -------
  const pad2 = (n)=> String(n).padStart(2,'0');

  // Fill select options 0..max
  function fillRange(sel, max){
    const frag = document.createDocumentFragment();
    for(let i=0;i<=max;i++){ const o = document.createElement('option'); o.value = i; o.textContent = i; frag.appendChild(o); }
    sel.appendChild(frag);
  }

  // ------- Elements -------
  const createModal = document.getElementById('createModal');
  const confirmCreate = document.getElementById('confirmCreate');
  const minSel = document.getElementById('minSel');
  const secSel = document.getElementById('secSel');
  const preview = document.getElementById('preview');

  const overlay = document.getElementById('timerOverlay');
  const bigTime = document.getElementById('bigTime');
  const playPause = document.getElementById('playPause');
  const playIcon = document.getElementById('playIcon');
  const pauseIcon = document.getElementById('pauseIcon');
  const resetBtn = document.getElementById('resetBtn');
  const muteBtn = document.getElementById('muteBtn');
  const soundOnIcon = document.getElementById('soundOnIcon');
  const soundOffIcon = document.getElementById('soundOffIcon');
  const deleteTimer = document.getElementById('deleteTimer');
  const progress = document.getElementById('progress');
  const statusEl = document.getElementById('status');
  const badge = document.getElementById('badge');
  const beep = document.getElementById('beep');

  // より確実な音声再生システム
  let audioContext = null;
  let isAudioReady = false;
  
  // シンプルな音声初期化
  function initAudio() {
    try {
      // HTMLオーディオ要素の準備
      beep.load();
      beep.volume = 0.5;
      
      // Web Audio APIの初期化
      if (!audioContext && (window.AudioContext || window.webkitAudioContext)) {
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        audioContext = new AudioContext();
        
        // サスペンド状態の場合は再開
        if (audioContext.state === 'suspended') {
          audioContext.resume();
        }
      }
      
      isAudioReady = true;
      console.log('Audio initialized successfully');
    } catch (e) {
      console.warn('Audio initialization failed:', e);
    }
  }
  
  // 確実な音声再生
  function playAlarmSound() {
    if (muted) {
      console.log('Sound is muted');
      return;
    }
    
    console.log('Playing alarm sound...');
    
    // 複数の方法で音声再生を試行
    let soundPlayed = false;
    
    // 方法1: HTMLオーディオ要素（最も確実）
    try {
      beep.currentTime = 0;
      const playPromise = beep.play();
      
      if (playPromise !== undefined) {
        playPromise.then(() => {
          console.log('HTML audio played successfully');
          soundPlayed = true;
        }).catch(e => {
          console.warn('HTML audio failed:', e);
          // 方法2: Web Audio APIでのビープ音生成
          tryWebAudioBeep();
        });
      } else {
        console.log('HTML audio play() returned undefined');
        tryWebAudioBeep();
      }
    } catch (e) {
      console.warn('HTML audio error:', e);
      tryWebAudioBeep();
    }
    
    // 方法3: 強制的なビープ音生成（最後の手段）
    setTimeout(() => {
      if (!soundPlayed) {
        console.log('Trying forced beep generation');
        // より確実なWeb Audio APIビープ音
        try {
          if (!audioContext) {
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            audioContext = new AudioContext();
          }
          
          if (audioContext.state === 'suspended') {
            audioContext.resume();
          }
          
          // 複数回のビープ音で目立たせる
          for (let i = 0; i < 3; i++) {
            setTimeout(() => {
              const oscillator = audioContext.createOscillator();
              const gainNode = audioContext.createGain();
              
              oscillator.connect(gainNode);
              gainNode.connect(audioContext.destination);
              
              oscillator.frequency.setValueAtTime(1000, audioContext.currentTime);
              oscillator.type = 'square';
              
              gainNode.gain.setValueAtTime(0, audioContext.currentTime);
              gainNode.gain.linearRampToValueAtTime(0.1, audioContext.currentTime + 0.02);
              gainNode.gain.linearRampToValueAtTime(0, audioContext.currentTime + 0.2);
              
              oscillator.start(audioContext.currentTime);
              oscillator.stop(audioContext.currentTime + 0.2);
              
              console.log(`Forced beep ${i + 1} played`);
            }, i * 300);
          }
        } catch (e) {
          console.warn('Forced beep generation failed:', e);
        }
      }
    }, 500);
  }
  
  function tryWebAudioBeep() {
    try {
      if (audioContext && audioContext.state === 'running') {
        // シンプルなビープ音を生成
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        // 設定
        oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
        oscillator.type = 'sine';
        
        // 音量調整
        gainNode.gain.setValueAtTime(0, audioContext.currentTime);
        gainNode.gain.linearRampToValueAtTime(0.3, audioContext.currentTime + 0.05);
        gainNode.gain.linearRampToValueAtTime(0, audioContext.currentTime + 0.6);
        
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.6);
        
        console.log('Web Audio beep played');
      } else if (audioContext && audioContext.state === 'suspended') {
        audioContext.resume().then(() => {
          tryWebAudioBeep(); // 再帰的に再試行
        });
      }
    } catch (e) {
      console.warn('Web Audio beep failed:', e);
    }
  }

  // preload a longer beep sound (base64-encoded wav)
  beep.src = 'data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmQaBTGN2fPPfCwGK4DO8tiNOQkZaLvt559NEAxQp+PwtmMcBjiR1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmQaBTGN2fPPfCwGK4DO8tiNOQkZaLvt559NEAxQp+PwtmMcBjiR1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmQaBTGN2fPPfCwGK4DO8tiNOQkZaLvt559NEAxQp+PwtmMcBjiR1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmQaBTGN2fPPfCwGK4DO8tiNOQkZaLvt559NEAxQp+PwtmMcBjiR1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmQaBTGN2fPPfCwGK4DO8tiNOQkZaLvt559NEAxQp+PwtmMcBjiR1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmQaBTGN2fPPfCwGK4DO8tiNOQkZaLvt559NEAxQp+PwtmMcBjiR1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmQaBTGN2fPPfCwGK4DO8tiNOQkZaLvt559NEAxQp+PwtmMcBjiR1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmQaBTGN2fPPfCwGK4DO8tiNOQkZaLvt559NEAxQp+PwtmMcBjiR1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmQaBTGN2fPPfCwGK4DO8tiNOQkZaLvt559NEAxQp+PwtmMcBjiR1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmQaBTGN2fPPfCwGK4DO8tiNOQkZaLvt559NEAxQp+PwtmMcBjiR1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmQaBTGN2fPPfCwGK4DO8tiNOQkZaLvt559NEAxQp+PwtmMcBjiR1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmQaBTGN2fPPfCwGK4DO8tiNOQkZaLvt559NEAxQp+PwtmMcBjiR1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmQaBTGN2fPPfCwGK4DO8tiNOQkZaLvt559NEAxQp+PwtmMcBjiR1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmQaBTGN2fPPfCwGK4DO8tiNOQkZaLvt559NEAxQp+PwtmMcBjiR1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmQaBTGN2fPPfCwGK4DO8tiNOQ=';

  // ------- Timer state -------
  let totalMs = 0;    // total duration
  let leftMs = 0;     // remaining
  let running = false;
  let rafId = null;   // animation frame id
  let lastTs = 0;     // timestamp for RAF
  let muted = false;
  const CIRCUM = 2*Math.PI*46; // r=46 -> ~289
  progress.setAttribute('stroke-dasharray', CIRCUM);

  function openModal(){
    createModal.style.display='flex';
    if(window.__firstOpen__ === undefined){
      window.__firstOpen__ = false; // mark initialized after first run
      // Set default to 05:00 on FIRST open only
      minSel.value = '5';
      secSel.value = '0';
      updatePreview();
    }
  }
  function closeModal(){ createModal.style.display='none'; }
  function openOverlay(){ overlay.style.display='flex'; }
  function closeOverlay(){ overlay.style.display='none'; stop(); }

  function updatePreview(){
    let m = Number(minSel.value||0);
    let s = Number(secSel.value||0);
    if(m === 60){
      // 60分時は 60:00 のみ許可
      s = 0;
      secSel.value = 0;
      secSel.disabled = true;
    }else{
      secSel.disabled = false;
    }
    preview.textContent = `${pad2(m)}:${pad2(s)}`;
  }

  function setInitial(min, sec){
    totalMs = (min*60 + sec) * 1000;
    leftMs = totalMs;
    render();
    badge.textContent = `${pad2(min)}:${pad2(sec)}`;
  }

  function render(){
    const sec = Math.ceil(leftMs/1000);
    const mm = Math.floor(sec/60); const ss = sec % 60;
    bigTime.textContent = `${pad2(mm)}:${pad2(ss)}`;
    const ratio = totalMs>0 ? (leftMs/totalMs) : 0;
    progress.setAttribute('stroke-dashoffset', String((1-ratio)*CIRCUM));
  }

  function tick(ts){
    if(!running){ return; }
    if(!lastTs) lastTs = ts;
    const dt = ts - lastTs; lastTs = ts;
    leftMs = Math.max(0, leftMs - dt);
    render();
    if(leftMs <= 0){
      stop();
      statusEl.textContent = '終了';
      
      // アラーム音を再生
      playAlarmSound();
      
      // 元のシンプルなフラッシュ効果
      overlay.animate([{background:'rgba(0,0,0,.48)'},{background:'rgba(255,255,255,.8)'},{background:'rgba(0,0,0,.48)'}],{duration:600});
      
      return;
    }
    rafId = requestAnimationFrame(tick);
  }

  function start(){
    if(totalMs<=0) return;
    if(leftMs<=0) leftMs = totalMs; // safeguard
    if(!running){ running = true; lastTs = 0; statusEl.textContent='カウント中';
      playIcon.style.display='none'; pauseIcon.style.display='block';
      rafId = requestAnimationFrame(tick);
    }
  }
  function stop(){
    running=false; if(rafId) cancelAnimationFrame(rafId); rafId=null; lastTs=0;
    playIcon.style.display='block'; pauseIcon.style.display='none';
    if(leftMs>0) statusEl.textContent='一時停止';
  }
  function reset(){ leftMs = totalMs; render(); statusEl.textContent='停止中'; }

  // ------- Event wiring -------
  fillRange(minSel, 60); fillRange(secSel, 59);
  minSel.value = 5; secSel.value = 0; updatePreview();
  // default should be 05:00
  try { console.assert(preview.textContent === '05:00', 'default preview should be 05:00'); } catch(_) {}

  minSel.addEventListener('input', updatePreview);
  secSel.addEventListener('input', updatePreview);

  confirmCreate.addEventListener('click', ()=>{
    // オーディオ初期化（ユーザー操作による）
    if (!isAudioReady) {
      initAudio();
    }
    
    const m = Number(minSel.value||0);
    let s = Number(secSel.value||0);
    if(m === 60) s = 0; // enforce 60:00 only
    if(m===0 && s===0){ alert('0:00 以外を選択してください。'); return; }
    closeModal();
    setInitial(m,s);
    bigTime.textContent = `${pad2(m)}:${pad2(s)}`;
    openOverlay();
  });

  playPause.addEventListener('click', ()=>{ 
    // オーディオ初期化（ユーザー操作による）
    if (!isAudioReady) {
      initAudio();
    }
    running ? stop() : start(); 
  });
  resetBtn.addEventListener('click', ()=>{ stop(); reset(); });
  
  muteBtn.addEventListener('click', ()=>{ 
    // オーディオ初期化（ユーザー操作による）
    if (!isAudioReady) {
      initAudio();
    }
    
    muted = !muted; 
    muteBtn.style.opacity = muted ? .4 : 1;
    muteBtn.style.filter = muted ? 'grayscale(1)' : 'grayscale(0)';
    muteBtn.setAttribute('aria-label', muted ? 'サウンドオフ（クリックでオン）' : 'サウンドオン（クリックでオフ）');
    
    // アイコンの切り替え
    if (muted) {
      soundOnIcon.style.display = 'none';
      soundOffIcon.style.display = 'block';
    } else {
      soundOnIcon.style.display = 'block';
      soundOffIcon.style.display = 'none';
      // ミュート解除時に短いテスト音を再生
      setTimeout(() => {
        try {
          beep.currentTime = 0;
          beep.play();
        } catch (e) {
          console.warn('Unmute test sound failed:', e);
        }
      }, 100);
    }
  });
  deleteTimer.addEventListener('click', ()=>{ 
    closeOverlay();
    openModal();
    setTimeout(()=> minSel && minSel.focus(), 0);
  });

  // Keyboard: Space to toggle
  document.addEventListener('keydown', (e)=>{
    if(overlay.style.display==='flex' && (e.code==='Space' || e.key===' ')){
      e.preventDefault(); running ? stop() : start();
    }
  });

  // Backdrop clicks disabled by request
  overlay.addEventListener('click', (e)=>{ /* timer backdrop click disabled */ });
  createModal.addEventListener('click', (e)=>{ /* time-picker backdrop click disabled */ });

  // Show the time picker immediately on load
  document.addEventListener('DOMContentLoaded', () => {
    openModal();
    setTimeout(()=> minSel && minSel.focus(), 0);
    
    // 音声の事前準備（即座に）
    try {
      beep.load();
      beep.volume = 0.5;
      console.log('Audio pre-loaded');
    } catch (e) {
      console.warn('Audio pre-load failed:', e);
    }
  });


  // Prevent closing with ESC on both modal and timer overlay
  document.addEventListener('keydown', (e)=>{
    if(e.code === 'Escape' || e.key === 'Escape'){
      if(createModal.style.display==='flex' || overlay.style.display==='flex'){
        e.preventDefault();
        e.stopPropagation();
      }
    }
  });

  // -------- Simple self-tests (console only) --------
  (function runSelfTests(){
    try{
      console.assert(pad2(5)==='05', 'pad2: 5 -> 05');
      console.assert(pad2(12)==='12', 'pad2: 12 -> 12');
      // range fill
      console.assert(minSel.options.length===61, 'minutes should have 0..60 (61 options)');
      console.assert(secSel.options.length===60, 'seconds should have 0..59 (60 options)');

      // Preserve UI state to avoid side effects
      const prevMin = minSel.value; const prevSec = secSel.value; const prevDisabled = secSel.disabled;

      const _t=totalMs, _l=leftMs; setInitial(0,30);
      console.assert(totalMs===30000 && leftMs===30000, 'setInitial 0:30 should be 30000ms');
      setInitial(60,0);
      console.assert(totalMs===3600000 && leftMs===3600000, 'setInitial 60:00 should be 3600000ms');

      // UI constraint tests
      minSel.value = '60'; secSel.value = '30'; updatePreview();
      console.assert(secSel.disabled === true && secSel.value === '0', 'minutes=60 should disable seconds and set to 0');
      console.assert(preview.textContent === '60:00', 'preview should show 60:00 when minutes=60');

      minSel.value = '59'; secSel.value = '45'; updatePreview();
      console.assert(secSel.disabled === false && secSel.value === '45', 'minutes<60 should allow seconds and keep selection');
      console.assert(preview.textContent === '59:45', 'preview should show 59:45');

      // Restore UI state
      minSel.value = prevMin; secSel.value = prevSec; secSel.disabled = prevDisabled; updatePreview();

      leftMs=_l; totalMs=_t; render(); // restore timer values

      // ESC should not close modal when visible (synthetic event)
      if(createModal.style.display==='flex'){
        const ev = new KeyboardEvent('keydown', {key:'Escape', code:'Escape', bubbles:true});
        document.dispatchEvent(ev);
        console.assert(createModal.style.display==='flex', 'ESC should not close time picker modal');
      }
      console.log('%cSelf-tests passed','color:#28c76f');
    }catch(err){ console.warn('Self-tests error', err); }
  })();
  </script>
</body>
</html>
